# API Payloads Documentation

This document describes exactly what JSON is sent to each backend endpoint.

## Application ID Generation

**Generated on:** Frontend when user leaves CompanyDetails step (step 0)

**Format:** `CompanyName-dd-mm-yyyy`

**Example:** `Voorbeeld BV-21-10-2025`

**Code:** `src/utils/applicationId.ts:generateApplicationId()`

The `applicationId` is:
- Generated client-side from company name + current date
- Saved to localStorage automatically
- Used in all subsequent backend calls
- Cleared when user completes the form

---

## 1. Submit Company Data (Step 0 → Step 1)

**Endpoint:** `POST ${apiBaseUrl}/api/submitCompanyInfo?code=${functionCode}`

**When:** User clicks "Volgende" on CompanyDetails step (step 0)

**Purpose:** Create application folder and save company data as Excel

**Payload:** Type-safe `CompanyInfo` model - **Step 0 fields only** (see `src/types/companyInfo.ts`)

```typescript
interface CompanyInfo {
  // Application metadata
  applicationId: string;
  tenantId: string;
  datum: string;

  // Bedrijfsinformatie
  bedrijfsnaam: string;
  kvkNummer: string;
  btwId: string;
  website: string;
  adres: string;
  postcode: string;
  plaats: string;
  provincie: string;
  naceClassificatie: string;

  // Contactpersoon
  contactNaam: string;
  contactTelefoon: string;
  contactEmail: string;
  contactGeslacht: 'man' | 'vrouw' | 'anders';
  hoofdcontactPersoon: 'Wout' | 'Tim' | 'Nathalie';
}
```

**Note:** Only Step 0 data is sent. Bestuurders, MKB data, and staatssteun data are collected in later steps and sent only to SignWell endpoint.

**Example:**
```json
{
  "applicationId": "Voorbeeld BV-21-10-2025",
  "tenantId": "mistersubsidie",
  "datum": "2025-10-21",
  "bedrijfsnaam": "Voorbeeld BV",
  "kvkNummer": "12345678",
  "btwId": "NL123456789B01",
  "website": "www.voorbeeld.nl",
  "adres": "Straatnaam 123",
  "postcode": "1234 AB",
  "plaats": "Amsterdam",
  "provincie": "Noord-Holland",
  "naceClassificatie": "6201",
  "contactNaam": "Jan Jansen",
  "contactTelefoon": "0612345678",
  "contactEmail": "contact@voorbeeld.nl",
  "contactGeslacht": "man",
  "hoofdcontactPersoon": "Wout"
}
```

**Expected Response:**
```json
{
  "success": true
}
```

**Backend Tasks:**
- Create folder: `Voorbeeld BV-21-10-2025/`
- Generate Excel from FormData
- Save as `company-data.xlsx` in folder
- Optionally start CRM sync

---

## 2. Upload Bank Statement (Step 1 → Step 2)

**Endpoint:** `POST /api/bankStatements`

**When:** User clicks "Volgende" on BankStatement step (step 1)

**Purpose:** Save bank statement PDF to application folder

**Payload:** `FormData` (multipart/form-data)

```
file: [Binary PDF file]
applicationId: "Voorbeeld BV-21-10-2025"
kvkNummer: "12345678"
bedrijfsnaam: "Voorbeeld BV"
```

**Expected Response:**
```json
{
  "success": true
}
```

**Backend Tasks:**
- Find/create application folder by `applicationId`
- Save PDF file to folder (e.g., `Voorbeeld BV-21-10-2025/bankStatement.pdf`)
- Validate file is PDF and under 10MB

---

## 3. Create Signing Session (Final Step)

**Endpoint:** `POST ${apiBaseUrl}/api/createSignWellTemplateSession?code=${functionCode}`

**When:** User clicks final submit button on Authorization step

**Purpose:** Create SignWell signing session with all collected data

**Payload:** SignWell template session (generated by `buildSigningSession`)

The payload contains:
- Template ID
- Signers (bestuurders with emails)
- Text tabs (only fields SignWell template needs):
  - Basic company: `bedrijfsnaam`, `kvk`, `onderneming-adres`, `postcode`, `plaats`, `nace`
  - Bestuurders: `voorletters-tekenbevoegde`, `achternaam-tekenbevoegde`, `functie-tekenbevoegde`
  - MKB data: `fte`, `jaaromzet`, `balanstotaal`, `boekjaar`
  - Staatssteun: `minimis-2.1`, `minimis-3.1`, `minimis-3.2` (conditional)
- Radio groups (converted to checkboxes):
  - De-minimis type: `geen`, `wel`, `andere`
  - Company size: `kleine`, `middel`, `grote`
- Application ID (for backend tracking)

```json
{
  // SignWell specific fields (from buildSigningSession)
  "template_id": "...",
  "name": "Machtiging - Voorbeeld BV",
  "recipients": [...],
  "fields": [...],

  // Our custom fields
  "applicationId": "Voorbeeld BV-21-10-2025",
  "tenantId": "mistersubsidie",
  "test": false
}
```

**Expected Response:**
```json
{
  "success": true,
  "documentId": "signwell_doc_id"
}
```

**Backend Tasks:**
- Create SignWell signing session
- Store signed documents in application folder when completed (via webhook)
- Send confirmation email via SignWell

---

## Complete Flow Summary

1. **Step 0 → 1:**
   - Frontend generates `applicationId` (CompanyName-dd-mm-yyyy)
   - Submits company data to backend → Backend creates folder + Excel file

2. **Step 1 → 2:**
   - Upload bank statement with `applicationId` → Backend saves to folder

3. **Final Step:**
   - Submit SignWell payload with `applicationId`
   - Backend creates signing session and stores signed docs when completed

All files end up in the same folder: `Voorbeeld BV-21-10-2025/`
- `company-data.xlsx` (from step 0)
- `bankStatement.pdf` (from step 1)
- `signed-documents.pdf` (from final step)

---

## LocalStorage Behavior

### What's Stored
The entire `FormData` object is automatically saved to localStorage (excluding the file itself):
- Key: `mister-subsidie-form-data`
- Includes: All form fields **including `applicationId`**
- Auto-saved: Every 500ms (debounced) when form data changes

### When It's Cleared
- When user reaches `/bedankt` (EndPage) - completion
- When user clicks "Nieuwe aanvraag"

### Persistence Flow
1. User fills CompanyDetails → auto-saved to localStorage
2. User clicks "Volgende" → `applicationId` generated and saved to localStorage
3. User closes browser → data persists
4. User returns → form data **and** `applicationId` restored
5. User can continue from where they left off

### Re-generation Prevention
If `applicationId` already exists in formData, generation is skipped:
```typescript
// In App.tsx:35
if (currentStep === 0 && !formData.applicationId) {
  const applicationId = generateApplicationId(formData);
  handleInputChange('applicationId', applicationId);
}
```
